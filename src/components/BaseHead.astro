---
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import '../styles/global.css';
import StructuredData from './StructuredData.astro';

interface Props {
	title: string;
	description: string;
	image?: string;
	article?: {
		pubDate: string;
		updatedDate?: string;
		tags?: string[];
	};
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image = '/maipdf-images/maipdf landing page.png', article } = Astro.props;

// Generate breadcrumb data
const breadcrumbItems = [
	{ name: "Home", url: "https://article.maipdf.com" }
];

// Generate hreflang links for blog posts
let hreflangLinks: Array<{ lang: string; url: string }> = [];
const pathParts = Astro.url.pathname.split('/').filter(Boolean);

if (Astro.url.pathname.startsWith('/blog/') && pathParts.length >= 3) {
	const slug = pathParts.slice(2).join('/');
	const langMap: Record<string, string> = {
		'cn': 'zh-CN',
		'en': 'en',
		'fr': 'fr',
		'de': 'de',
		'ja': 'ja',
		'ko': 'ko',
		'es': 'es'
	};
	const baseUrl = 'https://article.maipdf.com/blog/';
	const supportedLangs = Object.keys(langMap);
	
	supportedLangs.forEach(lang => {
		const langCode = langMap[lang];
		const altUrl = baseUrl + lang + '/' + slug;
		hreflangLinks.push({ lang: langCode, url: altUrl });
	});
	
	// Add x-default
	const defaultUrl = baseUrl + 'en/' + slug;
	hreflangLinks.push({ lang: 'x-default', url: defaultUrl });
}

if (Astro.url.pathname.startsWith('/blog')) {
	breadcrumbItems.push({ name: "Blog", url: "https://article.maipdf.com/blog" });
	
	// Add language breadcrumb if applicable
	if (pathParts.length > 1) {
		const language = pathParts[1];
		const languageNames: Record<string, string> = {
			'en': 'English',
			'cn': '中文',
			'fr': 'Français',
			'de': 'Deutsch',
			'ja': '日本語',
			'ko': '한국어',
			'es': 'Español'
		};
		if (languageNames[language]) {
			breadcrumbItems.push({ 
				name: languageNames[language], 
				url: 'https://article.maipdf.com/blog/' + language
			});
		}
	}
	
	// Add current page
	if (pathParts.length > 2) {
		breadcrumbItems.push({ 
			name: title, 
			url: canonicalURL.href 
		});
	}
}
---

<!-- Global Metadata - charset is already in Layout.astro head -->
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="manifest" href="/manifest.json" />
<meta name="generator" content={Astro.generator} />

<!-- Font preloads - Critical fonts only -->
<link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin />
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin />

<!-- Preconnect to Google Fonts for better performance -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Language and hreflang tags for blog posts -->
{hreflangLinks.map(link => (
	<link rel="alternate" hreflang={link.lang} href={link.url} />
))}

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={article ? "article" : "website"} />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image, Astro.url)} />
{article && (
	<>
		<meta property="article:published_time" content={article.pubDate} />
		{article.updatedDate && <meta property="article:modified_time" content={article.updatedDate} />}
		{article.tags && article.tags.map((tag) => (
			<meta property="article:tag" content={tag} />
		))}
	</>
)}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image, Astro.url)} />

<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9224406325142860" crossorigin="anonymous"></script>

<!-- Additional SEO Meta Tags -->
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
<meta name="googlebot" content="index, follow" />
<meta name="bingbot" content="index, follow" />

<!-- Language and Region -->
<meta name="language" content="en" />
<meta name="geo.region" content="US" />
<meta name="geo.placename" content="United States" />

<!-- Mobile App Meta Tags -->
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="MaiPDF Articles" />

<!-- Theme Color -->
<meta name="theme-color" content="#2337ff" />
<meta name="msapplication-TileColor" content="#2337ff" />

<!-- Structured Data -->
<StructuredData type="WebSite" data={{ name: "MaiPDF Articles", description: "Learn about PDF security, sharing, and management with MaiPDF" }} />
<StructuredData type="Organization" data={{}} />
<StructuredData type="BreadcrumbList" data={{ items: breadcrumbItems }} />

{article && (
	<StructuredData 
		type="Article" 
		data={{
			title,
			description,
			image,
			pubDate: article.pubDate,
			updatedDate: article.updatedDate,
			tags: article.tags
		}} 
	/>
)}

<!-- Removing CSP temporarily to allow AdSense to function correctly -->
<!-- AdSense often requires dynamic loading of resources which makes CSP challenging -->
<!-- If you need CSP, consider moving AdSense to a separate iframe -->

<script>
  // Set initial theme based on user preference or system settings
  const savedTheme = localStorage.getItem('theme');
  const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
  if (savedTheme) {
    document.documentElement.classList.add(savedTheme);
  } else if (prefersDarkMode) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.add('light');
  }
</script>

<script>
  // Define the toggleTheme function globally
  window.toggleTheme = () => {
    const htmlElement = document.documentElement;
    const isDarkMode = htmlElement.classList.contains('dark');
    if (isDarkMode) {
      htmlElement.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    } else {
      htmlElement.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    }
  };
</script>
